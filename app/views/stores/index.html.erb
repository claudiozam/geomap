<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
<style>
  html, body, #map-canvas {
    height: 100%;
    width: 100%;
    margin: 0px;
    padding: 0px
  }

  #panel {
    position: absolute;
    top: 5px;
    left: 50%;
    margin-left: -180px;
    z-index: 5;
    background-color: #fff;
    padding: 5px;
    border: 1px solid #999;
  }
</style>

<script>
  var geocoder;
  var map;
  var markers = [];


  function setAllMap(map) {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
    }
  }

  function clearMarkers() {
    setAllMap(null);
    markers = [];
  }

  function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var mapOptions = {
      zoom: 12,
      center: latlng
    }
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  }

  function getJSONStores(lat, lng, miles) {
    clearMarkers();   
    $.getJSON('/stores/near_points?lat=' + lat + '&lng=' + lng + '&miles=' +  miles, function(response) {
      
        
        for (var i = 0; i < response.length; i++) {
          var store = response[i];
          var poss = new google.maps.LatLng(store.latitude,
                                         store.longitude);

          var marker = new google.maps.Marker({
              map: map,
              position: poss
          });

          marker.store = store;

          google.maps.event.addListener(marker, 'click', function() {
            map.setCenter(marker.getPosition());
            alert(marker.store.name);
          });

          markers.push(marker);
  
        }

  
        $.unblockUI();
    });
  }

  function codeAddress() {
    var finalAddress = $('#cityInput').val() + ', ' + $('#countryInput').val();

    if($('#zipInput').val() != '') {
      finalAddress = $('#zipInput').val() + ', ' + finalAddress; 
    }

    $.blockUI();

    geocoder.geocode( { 'address': finalAddress}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        var location = results[0].geometry.location;
        map.setCenter(location);
        
        getJSONStores(location.lat(), location.lng(), $('#milesInput').val());

      } else {
        $.unblockUI();
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }

  google.maps.event.addDomListener(window, 'load', initialize);

</script>


<p id="notice"><%= notice %></p>

<h1>Listing Stores</h1>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Address 1</th>
      <th>City</th>
      <th>State</th>
      <th>Zip</th>
      <th>Country</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @stores.each do |store| %>
      <tr>
        <td><%= store.name %></td>
        <td><%= store.address_1 %></td>
        <td><%= store.city %></td>
        <td><%= store.state %></td>
        <td><%= store.zip %></td>
        <td><%= store.country %></td>
        <td><%= store.latitude %></td>
        <td><%= store.longitude %></td>
        <td><%= link_to 'Show', store %></td>
        <td><%= link_to 'Edit', edit_store_path(store) %></td>
        <td><%= link_to 'Destroy', store, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Store', new_store_path %>

<div id="panel">
  <input id="zipInput" type="textbox" placeholder="zip">
  <input id="cityInput" type="textbox" placeholder="city">
  <input id="countryInput" type="textbox" placeholder="country">
  <select id="milesInput">
    <option value="5">5 miles</option>
    <option value="10">10 miles</option>
    <option value="15">15 miles</option>
    <option value="20">20 miles</option>
    <option value="25">25 miles</option>
    <option value="30">30 miles</option>
  </select>
  <input type="button" value="Find!!!" onclick="codeAddress()">
</div>
<div id="map-canvas"></div>